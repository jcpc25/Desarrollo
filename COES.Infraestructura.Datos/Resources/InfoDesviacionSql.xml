<?xml version="1.0" encoding="utf-8" ?>

<Sqls>

  <Sql>
    <key>GetByCriteria</key>
    <query>
      select EQUINOMB as EMPRESA, BARRBARRATRANSFERENCIA as BARRA, EMPRNOMB as CLIENTE, CODENTCODIGO as CODIGO, D as DESVIACION from
      (select EM.EQUICODI, EM.BARRCODI, EM.EMPRCODI, EM.CODENTCODI,
      case when nvl(PE, 0) > 0 then ABS(EM-PE) / PE * 100 else 100 end as D from
      (select EQUICODI, BARRCODI, EMPRCODI, CODENTCODI, sum(TENTDESUMADIA) / :DIAS as EM
      from Transferencia.TRN_TRANS_ENTREGA T, Transferencia.TRN_TRANS_ENTREGA_DETALLE D
      where exists (select * from (select CODENTCODI, max(TENTVERSION) as TENTVERSION from Transferencia.TRN_TRANS_ENTREGA group by CODENTCODI) M
      where T.CODENTCODI = M.CODENTCODI and T.TENTVERSION = M.TENTVERSION)
      and T.TENTCODI = D.TENTCODI and PERICODI = :ANIOMES
      group by EQUICODI, BARRCODI, EMPRCODI, CODENTCODI) EM
      LEFT JOIN
      (select EQUICODI, BARRCODI, EMPRCODI, CODENTCODI, sum(TENTDESUMADIA) / :DIASMESES as PE
      from Transferencia.TRN_TRANS_ENTREGA T, Transferencia.TRN_TRANS_ENTREGA_DETALLE D
      where exists (select * from (select CODENTCODI, max(TENTVERSION) as TENTVERSION from Transferencia.TRN_TRANS_ENTREGA group by CODENTCODI) M
      where T.CODENTCODI = M.CODENTCODI and T.TENTVERSION = M.TENTVERSION)
      and T.TENTCODI = D.TENTCODI and PERICODI in (select PERICODI from Transferencia.TRN_PERIODO where PERIANIOMES between :ANIOMES1 and :ANIOMES2)
      group by EQUICODI, BARRCODI, EMPRCODI, CODENTCODI) PE
      on EM.EQUICODI = PE.EQUICODI and EM.BARRCODI = PE.BARRCODI
      and EM.EMPRCODI = PE.EMPRCODI and EM.CODENTCODI = PE.CODENTCODI
      where case when nvl(PE, 0) > 0 then ABS(EM-PE) / PE * 100 else 100 end > :DESVIACION) T,
      Transferencia.VW_SI_EMPRESA E, Transferencia.VW_EQ_CENTRAL_GENERACION G, Transferencia.TRN_BARRA B, Transferencia.TRN_CODIGO_ENTREGA C
      where T.EQUICODI = G.EQUICODI and T.BARRCODI = B.BARRCODI and T.EMPRCODI = E.EMPRCODI and T.CODENTCODI = C.CODENTCODI
      UNION
      select E.EMPRNOMB as EMPRESA, BARRBARRATRANSFERENCIA as BARRA, CL.EMPRNOMB as CLIENTE, TRETCODIGO as CODIGO, D as DESVIACION from
      (select EM.GENEMPRCODI, EM.BARRCODI, EM.CLIEMPRCODI, EM.TRETTABLA, EM.TRETCORESOCORESCCODI,
      case when nvl(PE, 0) > 0 then ABS(EM-PE) / PE * 100 else 100 end as D from
      (select GENEMPRCODI, BARRCODI, CLIEMPRCODI, TRETTABLA, TRETCORESOCORESCCODI, sum(TRETDESUMADIA) / :DIAS as EM
      from Transferencia.TRN_TRANS_RETIRO T, Transferencia.TRN_TRANS_RETIRO_DETALLE D
      where exists (select * from (select TRETTABLA, TRETCORESOCORESCCODI, max(TRETVERSION) as TRETVERSION from Transferencia.TRN_TRANS_RETIRO group by TRETTABLA, TRETCORESOCORESCCODI) M
      where T.TRETTABLA = M.TRETTABLA and T.TRETCORESOCORESCCODI = M.TRETCORESOCORESCCODI and T.TRETVERSION = M.TRETVERSION)
      and T.TRETCODI = D.TRETCODI and PERICODI = :ANIOMES
      group by GENEMPRCODI, BARRCODI, CLIEMPRCODI, TRETTABLA, TRETCORESOCORESCCODI) EM
      LEFT JOIN
      (select GENEMPRCODI, BARRCODI, CLIEMPRCODI, TRETTABLA, TRETCORESOCORESCCODI, sum(TRETDESUMADIA) / :DIASMESES as PE
      from Transferencia.TRN_TRANS_RETIRO T, Transferencia.TRN_TRANS_RETIRO_DETALLE D
      where exists (select * from (select TRETTABLA, TRETCORESOCORESCCODI, max(TRETVERSION) as TRETVERSION from Transferencia.TRN_TRANS_RETIRO group by TRETTABLA, TRETCORESOCORESCCODI) M
      where T.TRETTABLA = M.TRETTABLA and T.TRETCORESOCORESCCODI = M.TRETCORESOCORESCCODI and T.TRETVERSION = M.TRETVERSION)
      and T.TRETCODI = D.TRETCODI and PERICODI in (select PERICODI from Transferencia.TRN_PERIODO where PERIANIOMES between :ANIOMES1 and :ANIOMES2)
      group by GENEMPRCODI, BARRCODI, CLIEMPRCODI, TRETTABLA, TRETCORESOCORESCCODI) PE
      on EM.GENEMPRCODI = PE.GENEMPRCODI and EM.BARRCODI = PE.BARRCODI
      and EM.CLIEMPRCODI = PE.CLIEMPRCODI and EM.TRETTABLA = PE.TRETTABLA and EM.TRETCORESOCORESCCODI = PE.TRETCORESOCORESCCODI
      where case when nvl(PE, 0) > 0 then ABS(EM-PE) / PE * 100 else 100 end > :DESVIACION) T,
      Transferencia.VW_SI_EMPRESA E, Transferencia.TRN_BARRA B, Transferencia.VW_SI_EMPRESA CL, Transferencia.VW_TRN_CODIGO_RETIRO C
      where T.GENEMPRCODI = E.EMPRCODI and T.BARRCODI = B.BARRCODI and T.CLIEMPRCODI = CL.EMPRCODI
      and T.TRETTABLA = C.TRETTABLA and T.TRETCORESOCORESCCODI = C.TRETCORESOCORESCCODI
    </query>
  </Sql>

</Sqls>
